<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é—²äº‘é™„é­”ä¹¦æŸ¥è¯¢ | Xianyun Enchant Search</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* é»˜è®¤ä¸»é¢˜ (White - 6:00~18:00) */
            --c-bg: #f0f2f5;
            --c-bg-soft: #ffffff;
            --c-card-bg: #ffffff;
            --c-text: #2c3e50;
            --c-text-secondary: #606266;
            --c-text-light: #909399;
            --c-accent: #3eaf7c;
            --c-border: #e4e7ed;
            --c-modal-bg: rgba(255, 255, 255, 0.95);
            --c-sidebar-bg: rgba(255, 255, 255, 0.98);
            --shadow-soft: 0 8px 30px rgba(0,0,0,0.08);
            --nav-height: 68px;
            --gate-bg-day: #f0f2f5;
            --gate-bg-night: #1a1a1a;
            --gate-text-day: #2c3e50;
            --gate-text-night: #ffd700;
            
            /* æ‚¬æµ®çª—é»˜è®¤é¢œè‰² (ç™½æ˜¼) */
            --tooltip-bg: rgba(255, 255, 255, 0.95);
            --tooltip-text: #2c3e50;
            --tooltip-border: #e4e7ed;

            /* å“è´¨é¢œè‰²å˜é‡ */
            --q-white: #909399;
            --q-green: #67c23a;
            --q-blue: #409eff;
            --q-purple: #a355d6;
            --q-gold: #e6a23c;
            --q-red: #f56c6c;
        }

        /* é»‘è‰²ä¸»é¢˜ (Black - 18:00~6:00) */
        [data-theme="black"] {
            --c-bg: #0f0f11;
            --c-bg-soft: #18181b;
            --c-card-bg: #222225;
            --c-text: #ffffff;
            --c-text-secondary: #e4e4e7;
            --c-text-light: #71717a;
            --c-accent: #a78bfa;
            --c-border: #2f2f35;
            --c-modal-bg: rgba(34, 34, 37, 0.98);
            --c-sidebar-bg: rgba(24, 24, 27, 0.98);
            --shadow-soft: 0 10px 40px -10px rgba(0,0,0,0.8);
            
            /* æ‚¬æµ®çª—é¢œè‰² (é»‘å¤œ) */
            --tooltip-bg: rgba(34, 34, 37, 0.95);
            --tooltip-text: #ffffff;
            --tooltip-border: #2f2f35;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            color: var(--c-text);
            background-color: var(--c-bg);
            padding-top: var(--nav-height);
            line-height: 1.6;
            overflow-x: hidden;
            transition: color 0.3s; 
        }

        /* --- å‘½è¿ä¹‹é—¨è½¬åœºåŠ¨ç”» --- */
        #gate-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9999; pointer-events: none; display: flex;
            justify-content: center; align-items: center;
            visibility: hidden;
            transition: visibility 0s 0.6s;
        }
        #gate-overlay.active {
            pointer-events: all; visibility: visible; transition: visibility 0s 0s;
        }
        
        .gate-panel {
            position: absolute; 
            background: #1a1a1a;
            transition: transform 0.6s cubic-bezier(0.65, 0, 0.35, 1);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            will-change: transform;
            overflow: hidden;
        }

        /* å·¦å³é—¨ (è§†å›¾åˆ‡æ¢) */
        .gate-side { height: 100%; width: 50%; top: 0; }
        .gate-left { left: 0; transform: translateX(-101%); border-right: 2px solid var(--gate-text-night); }
        .gate-right { right: 0; transform: translateX(101%); border-left: 2px solid var(--gate-text-night); }
        
        #gate-overlay.type-h.active .gate-left { transform: translateX(0); }
        #gate-overlay.type-h.active .gate-right { transform: translateX(0); }

        /* ä¸Šä¸‹é—¨ (ä¸»é¢˜åˆ‡æ¢) */
        .gate-vertical { width: 100%; height: 50%; left: 0; }
        .gate-top { 
            top: 0; transform: translateY(-101%); 
            background: var(--gate-bg-day); 
            border-bottom: 3px solid var(--gate-text-day);
            color: var(--gate-text-day);
        }
        .gate-bottom { 
            bottom: 0; transform: translateY(101%); 
            background: var(--gate-bg-night); 
            border-top: 3px solid var(--gate-text-night);
            color: var(--gate-text-night);
        }

        #gate-overlay.type-v.active .gate-top { transform: translateY(0); }
        #gate-overlay.type-v.active .gate-bottom { transform: translateY(0); }

        .gate-content {
            font-size: 3rem; font-weight: 800; opacity: 0;
            transition: opacity 0.3s; font-family: 'Courier New', Courier, monospace;
            text-transform: uppercase; letter-spacing: 4px;
            text-align: center; padding: 0 10px;
        }
        .gate-side .gate-content { color: var(--gate-text-night); }
        
        #gate-overlay.active .gate-content { opacity: 1; transition-delay: 0.2s; }
        
        .gate-arrow {
            position: absolute; z-index: 10000; 
            font-size: 4rem; opacity: 0; transition: 0.3s; 
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }
        #gate-overlay.type-h .gate-arrow { color: var(--gate-text-night); }
        #gate-overlay.type-v .gate-arrow { color: #fff; mix-blend-mode: difference; }
        #gate-overlay.active .gate-arrow { opacity: 1; transition-delay: 0.2s; transform: scale(1.2); }

        /* --- å¯¼èˆªæ  --- */
        .navbar {
            position: fixed; top: 0; left: 0; right: 0; height: var(--nav-height);
            background-color: var(--c-sidebar-bg);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--c-border);
            display: flex; align-items: center; padding: 0 2rem;
            z-index: 100; justify-content: space-between;
        }

        .navbar-title {
            font-weight: 800; font-size: 1.3rem; color: var(--c-text);
            display: flex; align-items: center; gap: 10px;
            white-space: nowrap;
        }

        .nav-controls { display: flex; gap: 15px; align-items: center; }
        
        .view-btn-group {
            display: flex; gap: 8px; background: var(--c-bg);
            padding: 4px; border-radius: 8px; border: 1px solid var(--c-border);
        }

        .view-icon-btn {
            width: 36px; height: 36px; border-radius: 6px; border: none;
            background: transparent; color: var(--c-text-light);
            cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center;
            font-size: 1rem;
        }
        .view-icon-btn:hover { color: var(--c-text); background: var(--c-card-bg); }
        .view-icon-btn.active { background: var(--c-card-bg); color: var(--c-accent); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .toggle-group {
            background: var(--c-bg); padding: 4px; border-radius: 99px;
            display: flex; position: relative;
            border: 1px solid var(--c-border);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }

        .toggle-option {
            padding: 6px 18px; cursor: pointer; z-index: 2;
            font-size: 0.85rem; font-weight: 600;
            color: var(--c-text-light); transition: color 0.3s;
            display: flex; align-items: center; justify-content: center;
            min-width: 50px;
        }
        .toggle-option.active { color: var(--c-text); }
        
        .toggle-pill {
            position: absolute; top: 4px; bottom: 4px;
            background: var(--c-card-bg); border-radius: 99px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            z-index: 1;
        }
        
        #langSwitch .toggle-pill { width: calc(100% / 3 - 3px); }
        #themeSwitch .toggle-pill { width: calc(100% / 2 - 4px); }

        /* --- é¡µé¢è§†å›¾å®¹å™¨ --- */
        .view-section { display: none; width: 100%; height: calc(100vh - var(--nav-height)); position: relative; }
        .view-section.active { display: block; }
        
        /* åˆ—è¡¨è§†å›¾é«˜åº¦è‡ªåŠ¨ */
        #view-list { height: auto; min-height: 100vh; }

        /* --- 1. åˆ—è¡¨è§†å›¾æ ·å¼ --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem 1.5rem 6rem 1.5rem; }
        .hero { text-align: center; margin-bottom: 3rem; }
        .hero h1 { font-size: 2.5rem; margin-bottom: 0.5rem; color: var(--c-text); }
        .hero p { color: var(--c-text-light); font-size: 1.1rem; margin-bottom: 2rem; }
        .hero-search-input {
            width: 100%; max-width: 500px; padding: 1rem 1.5rem;
            font-size: 1rem; border: 1px solid var(--c-border); border-radius: 50px;
            background: var(--c-card-bg); color: var(--c-text);
            box-shadow: var(--shadow-soft); outline: none; text-align: center;
        }
        .filters { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 2rem; }
        .filter-btn {
            padding: 6px 16px; border-radius: 20px; border: 1px solid transparent;
            background: var(--c-card-bg); color: var(--c-text-light);
            cursor: pointer; font-weight: 600; font-size: 0.9rem;
            white-space: nowrap;
        }
        .filter-btn.active { background: var(--c-text); color: var(--c-bg-soft); }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        
        .card {
            background: var(--c-card-bg); border-radius: 16px; padding: 1.5rem;
            position: relative; cursor: pointer;
            border: 2px solid transparent; 
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            transform-origin: center 80%; overflow: hidden;
        }
        /* Desktop Hover Effect */
        @media (hover: hover) {
            .card:hover {
                transform: translateY(-12px) scale(1.02) perspective(1000px) rotateX(3deg);
                box-shadow: 0 25px 50px -12px rgba(0,0,0,0.2);
                border-color: var(--card-color); z-index: 10;
            }
        }
        .card:active {
             transform: scale(0.98);
        }
        .card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%;
            background: var(--card-color); opacity: 0.8;
        }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.8rem; }
        .card-title { font-size: 1.1rem; font-weight: 700; color: var(--c-text); word-break: break-word;}
        .card-price { font-weight: 700; color: #d35400; background: rgba(230, 126, 34, 0.1); padding: 4px 8px; border-radius: 6px; font-size: 0.9rem; white-space: nowrap; margin-left: 8px;}
        .card-body { font-size: 0.9rem; color: var(--c-text-secondary); margin-bottom: 1.5rem; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; min-height: 4.2em; }
        
        .card-footer { 
            padding-top: 1rem; 
            border-top: 1px solid var(--c-border); 
            display: flex; 
            justify-content: space-between; 
            color: var(--c-text-light); 
            font-size: 0.85rem; 
            padding-right: 50px; /* ç»™æŒ‰é’®ç•™å‡ºç©ºé—´ */
        }
        
        .card-action-btn {
            position: absolute; bottom: 15px; right: 15px;
            width: 36px; height: 36px; border-radius: 12px;
            background: var(--c-bg); color: var(--c-text); border: 1px solid var(--c-border);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            z-index: 5;
        }

        /* --- 2. æ˜Ÿå›¾è§†å›¾æ ·å¼ (Galaxy Map) --- */
        #galaxy-container {
            width: 100%; height: 100%;
            background-color: #000;
            background-image: 
                radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 3px),
                radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 2px),
                radial-gradient(rgba(255,255,255,.1), rgba(255,255,255,.1) 2px, transparent 3px);
            background-size: 550px 550px, 350px 350px, 250px 250px;
            background-position: 0 0, 40px 60px, 130px 270px;
            overflow: hidden; position: relative; cursor: grab;
            touch-action: none; /* ç¦æ­¢é»˜è®¤è§¦æ‘¸è¡Œä¸º */
        }
        #galaxy-container:active { cursor: grabbing; }
        
        /* èŠ‚ç‚¹å±‚ (åŒ…å«Canvaså’ŒHTMLèŠ‚ç‚¹) */
        #galaxy-nodes {
            position: absolute; top: 0; left: 0; transform-origin: 0 0;
        }

        /* è¿çº¿ Canvas */
        #galaxy-lines {
            position: absolute; pointer-events: none; z-index: 1;
        }

        /* èŠ‚ç‚¹æ ·å¼ */
        .galaxy-node {
            position: absolute; width: 14px; height: 14px;
            border-radius: 50%; background: var(--node-color);
            box-shadow: 0 0 10px var(--node-color), 0 0 20px var(--node-color);
            transform: translate(-50%, -50%); cursor: pointer;
            transition: transform 0.2s;
            z-index: 10;
            border: 2px solid rgba(255,255,255,0.8);
            animation: twinkle 2s infinite alternate;
        }
        
        @keyframes twinkle {
            0% { opacity: 0.7; transform: translate(-50%, -50%) scale(0.9); box-shadow: 0 0 5px var(--node-color); }
            100% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); box-shadow: 0 0 25px var(--node-color); }
        }

        .galaxy-node:hover { 
            animation: none;
            transform: translate(-50%, -50%) scale(1.5); 
            z-index: 20; 
            background: #fff; 
        }
        
        .galaxy-label {
            position: absolute; top: 16px; left: 50%; transform: translateX(-50%);
            color: #fff; font-size: 10px; white-space: nowrap; text-shadow: 0 2px 4px #000;
            pointer-events: none; opacity: 0.6; font-weight: bold; transition: opacity 0.2s;
        }
        .galaxy-node:hover .galaxy-label { opacity: 1; color: var(--node-color); font-size: 12px; }

        /* --- é€šç”¨æ‚¬æµ®çª— (é€‚é…ä¸»é¢˜é…è‰²) --- */
        #mini-tooltip {
            position: fixed; top: 0; left: 0;
            background: var(--tooltip-bg); 
            color: var(--tooltip-text);
            padding: 12px 16px; border-radius: 12px;
            pointer-events: none; z-index: 9999; font-size: 0.9rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            opacity: 0; transition: opacity 0.2s; max-width: 280px;
            backdrop-filter: blur(10px); 
            border: 1px solid var(--tooltip-border);
            transform: translateY(10px);
        }
        #mini-tooltip.visible { opacity: 1; transform: translateY(0); }
        .tooltip-name { font-weight: 800; font-size: 1.1rem; margin-bottom: 4px; color: var(--color); border-bottom: 1px solid rgba(128,128,128,0.2); padding-bottom: 4px; }
        .tooltip-price { color: #d35400; font-weight: bold; margin-bottom: 6px; display: block; font-size: 0.95rem; }
        .tooltip-desc { font-size: 0.85rem; color: var(--c-text-secondary); line-height: 1.5; }

        /* --- è¯¦æƒ…æ¨¡æ€æ¡† --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            z-index: 2000; opacity: 0; visibility: hidden; transition: 0.3s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content {
            background: var(--c-modal-bg); width: 90%; max-width: 500px;
            border-radius: 20px; padding: 2rem; 
            border: 1px solid var(--c-border);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.3);
            transform: scale(0.9); opacity: 0; transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative; 
            max-height: 90vh; overflow-y: auto;
        }
        .modal-overlay.active .modal-content { transform: scale(1); opacity: 1; }
        .modal-close-btn {
            position: absolute; top: 20px; right: 20px; width: 32px; height: 32px; border-radius: 50%;
            background: var(--c-bg); border: 1px solid var(--c-border); color: var(--c-text-light);
            cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .modal-close-btn:hover { background: var(--c-border); transform: rotate(90deg); color: var(--c-text); }
        .modal-header { margin-bottom: 1.5rem; padding-right: 30px; }
        .modal-title { font-size: 1.6rem; font-weight: 700; color: var(--c-text); word-break: break-word;}
        .detail-grid { display: grid; grid-template-columns: 90px 1fr; gap: 12px; margin-top: 1.5rem; font-size: 0.95rem; }
        .detail-label { color: var(--c-text-light); font-weight: 600; }
        .detail-value { color: var(--c-text); }
        .conflict-tag {
            display: inline-block; padding: 3px 8px; border-radius: 6px;
            font-size: 0.8rem; margin-right: 5px; margin-bottom: 5px;
            color: #fff; font-weight: 600; background-color: var(--tag-bg);
        }

        /* --- è´­ç‰©è½¦ & ç¡®è®¤æ¡† --- */
        .cart-fab { position: fixed; bottom: 40px; right: 40px; width: 64px; height: 64px; border-radius: 24px; background: var(--c-text); color: var(--c-bg); box-shadow: 0 15px 30px rgba(0,0,0,0.25); display: flex; align-items: center; justify-content: center; font-size: 1.4rem; cursor: pointer; z-index: 1000; transition: all 0.3s; }
        .cart-fab:hover { transform: rotate(-5deg) scale(1.1); }
        .cart-count { position: absolute; top: -6px; right: -6px; background: var(--c-accent); color: #fff; width: 24px; height: 24px; border-radius: 50%; font-size: 0.8rem; font-weight: bold; display: flex; align-items: center; justify-content: center; border: 2px solid var(--c-bg); opacity: 0; }
        .cart-count.visible { opacity: 1; }
        .cart-sidebar { position: fixed; top: 0; right: -420px; width: 400px; height: 100%; background: var(--c-sidebar-bg); backdrop-filter: blur(20px); border-left: 1px solid var(--c-border); z-index: 1200; transition: right 0.4s; display: flex; flex-direction: column; padding: 2rem; box-shadow: -20px 0 50px rgba(0,0,0,0.1); }
        .cart-sidebar.open { right: 0; }
        .cart-header { position: relative; margin-bottom: 1rem; display: flex; align-items: center; justify-content: space-between; }
        .cart-close-btn { border: none; background: none; cursor: pointer; font-size: 1.5rem; color: var(--c-text); }
        .cart-items { flex: 1; overflow-y: auto; }
        
        /* è´­ç‰©è½¦é¡¹ç›®æ ·å¼ (åŒ…å«æ•°é‡æ§åˆ¶) */
        .cart-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 1rem; 
            background: var(--c-bg); 
            border-radius: 12px; 
            margin-bottom: 10px; 
            border: 1px solid var(--c-border); 
            flex-wrap: wrap; /* å…è®¸å°å±å¹•æ¢è¡Œ */
            gap: 10px; 
        }
        .cart-item-info {
            flex: 1;
            min-width: 120px;
        }
        .cart-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .qty-group {
            display: flex;
            align-items: center;
            background: var(--c-bg-soft);
            border: 1px solid var(--c-border);
            border-radius: 8px;
            padding: 2px;
        }
        .qty-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            color: var(--c-text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            transition: background 0.2s;
            border-radius: 6px;
        }
        .qty-btn:hover {
            background: var(--c-border);
        }
        .qty-input {
            width: 36px;
            height: 28px;
            border: none;
            background: transparent;
            text-align: center;
            color: var(--c-text);
            font-weight: 600;
            font-size: 0.95rem;
            outline: none;
            padding: 0;
            -moz-appearance: textfield;
        }
        .qty-input::-webkit-outer-spin-button,
        .qty-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .cart-del-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--c-text-light);
            cursor: pointer;
            transition: color 0.2s;
            border-radius: 50%;
        }
        .cart-del-btn:hover {
            color: var(--q-red);
            background: rgba(245, 108, 108, 0.1);
        }

        .cart-footer { margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--c-border); }
        .total-row { display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: 700; margin-bottom: 1.5rem; }
        .btn-block { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; }
        .btn-clear { background: var(--c-bg); color: var(--c-text-light); border: 1px solid var(--c-border); }
        .confirm-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.1); backdrop-filter: blur(5px); z-index: 3000; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: 0.3s; }
        .confirm-modal.active { opacity: 1; visibility: visible; }
        .confirm-card { background: var(--c-modal-bg); width: 320px; padding: 2rem; border-radius: 16px; text-align: center; border: 1px solid var(--c-border); box-shadow: 0 20px 60px rgba(0,0,0,0.2); transform: scale(0.8); transition: 0.3s; }
        .confirm-modal.active .confirm-card { transform: scale(1); }
        .confirm-actions { display: flex; gap: 10px; margin-top: 1.5rem; }
        .confirm-btn { flex: 1; padding: 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
        .btn-yes { background: var(--c-text); color: var(--c-bg); }
        .btn-no { background: var(--c-bg); color: var(--c-text); }

        /* --- ç§»åŠ¨ç«¯å“åº”å¼ä¼˜åŒ– --- */
        @media (max-width: 768px) {
            .navbar { padding: 0 1rem; height: 60px; }
            body { padding-top: 60px; }
            .navbar-title { font-size: 1.1rem; }
            .nav-controls { gap: 8px; }
            .toggle-option { padding: 5px 10px; min-width: 36px; font-size: 0.8rem; }
            .view-icon-btn { width: 32px; height: 32px; }
            
            .hero h1 { font-size: 1.8rem; padding: 0 10px;}
            .hero p { font-size: 0.9rem; padding: 0 20px;}
            .hero-search-input { width: 90%; }
            .container { padding: 1.5rem 1rem 6rem 1rem; }
            
            /* ç­›é€‰æ æ°´å¹³æ»šåŠ¨ */
            .filters { 
                justify-content: flex-start; 
                overflow-x: auto; 
                padding-bottom: 10px; 
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            .filters::-webkit-scrollbar { display: none; }
            
            .grid { grid-template-columns: repeat(auto-fill, minmax(100%, 1fr)); gap: 1rem; }
            .card { transform: none !important; } /* ç§»é™¤æ‰‹æœºç«¯ hover æ•ˆæœ */
            
            .cart-sidebar { width: 100%; right: -100%; }
            .cart-fab { bottom: 20px; right: 20px; width: 56px; height: 56px; font-size: 1.2rem; }
            
            .gate-content { font-size: 1.8rem; letter-spacing: 2px; }
            .gate-arrow { font-size: 2.5rem; }
            
            .modal-content { width: 95%; padding: 1.5rem; }
            .modal-title { font-size: 1.4rem; }
            .detail-grid { grid-template-columns: 70px 1fr; }
        }
        @media (max-width: 400px) {
             .navbar-title span { display: none; } /* è¶…å°å±éšè—æ ‡é¢˜æ–‡å­—åªç•™å›¾æ ‡ */
             .navbar-title i { font-size: 1.5rem; }
        }
    </style>
</head>
<body>

    <!-- æ‚¬æµ®çª— -->
    <div id="mini-tooltip">
        <div class="tooltip-name"></div>
        <span class="tooltip-price"></span>
        <div class="tooltip-desc"></div>
    </div>

    <!-- å‘½è¿ä¹‹é—¨è½¬åœºå±‚ -->
    <div id="gate-overlay">
        <!-- æ¨ªå‘é—¨ -->
        <div class="gate-panel gate-side gate-left">
            <span class="gate-content" id="gate-text-left"></span>
        </div>
        <div class="gate-panel gate-side gate-right">
            <span class="gate-content" id="gate-text-right"></span>
        </div>
        <!-- çºµå‘é—¨ -->
        <div class="gate-panel gate-vertical gate-top">
            <span class="gate-content">ç™½æ˜¼ (DAY)</span>
        </div>
        <div class="gate-panel gate-vertical gate-bottom">
            <span class="gate-content">é»‘å¤œ (NIGHT)</span>
        </div>
        <div class="gate-arrow" id="gate-arrow"></div>
    </div>

    <nav class="navbar">
        <div class="navbar-title">
            <i class="fa-solid fa-book-open" style="color:var(--c-accent)"></i>
            <span data-i18n="nav_title">é—²äº‘é™„é­”ä¹¦æŸ¥è¯¢</span>
        </div>
        
        <div class="nav-controls">
            <!-- è§†å›¾åˆ‡æ¢æŒ‰é’®ç»„ -->
            <div class="view-btn-group">
                <button class="view-icon-btn active" id="btn-list" onclick="switchView('list')" title="åˆ—è¡¨è§†å›¾">
                    <i class="fa-solid fa-list"></i>
                </button>
                <button class="view-icon-btn" id="btn-galaxy" onclick="switchView('galaxy')" title="æ˜Ÿå›¾è§†å›¾">
                    <i class="fa-solid fa-star"></i>
                </button>
            </div>

            <!-- è¯­è¨€åˆ‡æ¢ (å·²éšè—ï¼Œé»˜è®¤ä¸­æ–‡) -->
            <div class="toggle-group" id="langSwitch" style="display: none;">
                <div class="toggle-pill"></div>
                <div class="toggle-option active" data-lang="zh" data-idx="0">ä¸­</div>
                <div class="toggle-option" data-lang="en" data-idx="1">EN</div>
                <div class="toggle-option" data-lang="jp" data-idx="2">JP</div>
            </div>

            <!-- ä¸»é¢˜åˆ‡æ¢ -->
            <div class="toggle-group" id="themeSwitch">
                <div class="toggle-pill"></div>
                <div class="toggle-option active" data-theme="white"><i class="fa-solid fa-sun"></i></div>
                <div class="toggle-option" data-theme="black"><i class="fa-solid fa-moon"></i></div>
            </div>
        </div>
    </nav>

    <!-- 1. åˆ—è¡¨è§†å›¾ -->
    <div class="view-section active" id="view-list">
        <div class="container">
            <div class="hero">
                <h1 data-i18n="hero_title">é—²äº‘é™„é­”ä¹¦æŸ¥è¯¢</h1>
                <p data-i18n="hero_subtitle">æŸ¥è¯¢ä»·æ ¼ï¼Œæ·»åŠ è‡³æ¸…å•è‡ªåŠ¨è®¡ç®—æ€»é¢„ç®—</p>
                <input type="text" class="hero-search-input" id="searchInput" placeholder="æœç´¢åç§°ã€ç”¨é€”ã€è£…å¤‡éƒ¨ä½..." autocomplete="off">
            </div>

            <div class="filters" id="filterContainer">
                <button class="filter-btn active" data-color="all" data-i18n="filter_all">å…¨éƒ¨</button>
                <button class="filter-btn" data-color="ç™½" data-i18n="filter_white">ç™½ (æ™®é€š)</button>
                <button class="filter-btn" data-color="ç»¿" data-i18n="filter_green">ç»¿ (ä¼˜ç§€)</button>
                <button class="filter-btn" data-color="è“" data-i18n="filter_blue">è“ (ç¨€æœ‰)</button>
                <button class="filter-btn" data-color="ç´«" data-i18n="filter_purple">ç´« (å²è¯—)</button>
                <button class="filter-btn" data-color="é‡‘" data-i18n="filter_gold">é‡‘ (ä¼ è¯´)</button>
                <button class="filter-btn" data-color="çº¢" data-i18n="filter_red">çº¢ (ç¥è¯)</button>
            </div>

            <div class="grid" id="gridContainer"></div>
        </div>
    </div>

    <!-- 2. æ˜Ÿå›¾è§†å›¾ (Galaxy) -->
    <div class="view-section" id="view-galaxy">
        <div id="galaxy-container">
            <!-- èŠ‚ç‚¹å±‚: åŒ…å«çº¿å’Œç‚¹ï¼Œä¸€èµ·ç¼©æ”¾å¹³ç§» -->
            <div id="galaxy-nodes">
                <canvas id="galaxy-lines"></canvas>
                <!-- èŠ‚ç‚¹ç”± JS ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- è´­ç‰©è½¦ -->
    <div class="cart-fab" id="cartFab"><i class="fa-solid fa-cash-register"></i><div class="cart-count" id="cartCount">0</div></div>
    <div class="cart-sidebar" id="cartSidebar">
        <div class="cart-header">
            <h2 data-i18n="cart_title">ä»·æ ¼è®¡ç®—å™¨</h2>
            <button class="cart-close-btn" onclick="closeSidebar()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="cart-items" id="cartItems"><div style="text-align:center; color:var(--c-text-light); margin-top:4rem;" data-i18n="cart_empty">æ¸…å•ç©ºç©ºå¦‚ä¹Ÿ</div></div>
        <div class="cart-footer">
            <div class="total-row"><span data-i18n="cart_total">æ€»è®¡</span><span style="color:var(--c-accent)" id="totalPrice">ğŸª™ 0</span></div>
            <button class="btn-block btn-clear" id="openClearConfirm" data-i18n="btn_clear">æ¸…ç©ºè®¡ç®—å™¨</button>
        </div>
    </div>
    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-card">
            <h3 style="margin-bottom:10px;color:var(--c-text)" data-i18n="confirm_title">ç¡®è®¤æ¸…ç©º?</h3>
            <div class="confirm-actions"><button class="confirm-btn btn-no" onclick="closeConfirm()" data-i18n="btn_cancel">å–æ¶ˆ</button><button class="confirm-btn btn-yes" onclick="performClear()" data-i18n="btn_confirm">ç¡®è®¤æ¸…ç©º</button></div>
        </div>
    </div>
    <div class="modal-overlay" id="modalOverlay"><div class="modal-content" id="modalContent"></div></div>

<script>

// æ ¸å¿ƒæ•°æ®ç¿»è¯‘å­—å…¸
const translationDB = {
    "æ— å†²çª": { en: "None", jp: "ãªã—" },
    "å…¨éƒ¨å·¥å…·": { en: "All Tools", jp: "å…¨ãƒ„ãƒ¼ãƒ«" }, "å…¨éƒ¨é˜²å…·": { en: "All Armor", jp: "å…¨é˜²å…·" },
    "å‰‘": { en: "Sword", jp: "å‰£" }, "æ–§": { en: "Axe", jp: "æ–§" }, "å¼“": { en: "Bow", jp: "å¼“" },
    "å¼©": { en: "Crossbow", jp: "ã‚¯ãƒ­ã‚¹ãƒœã‚¦" }, "é´å­": { en: "Boots", jp: "ãƒ–ãƒ¼ãƒ„" },
    "å¸½å­": { en: "Helmet", jp: "ãƒ˜ãƒ«ãƒ¡ãƒƒãƒˆ" }, "èƒ¸ç”²": { en: "Chestplate", jp: "ãƒã‚§ã‚¹ãƒˆãƒ—ãƒ¬ãƒ¼ãƒˆ" },
    "è£¤è¡©": { en: "Leggings", jp: "ãƒ¬ã‚®ãƒ³ã‚¹" }, "ç¨¿": { en: "Pickaxe", jp: "ãƒ„ãƒ«ãƒã‚·" },
    "é“²": { en: "Shovel", jp: "ã‚·ãƒ£ãƒ™ãƒ«" }, "é”„": { en: "Hoe", jp: "ã‚¯ãƒ¯" },
    "é’“é±¼ç«¿": { en: "Fishing Rod", jp: "é‡£ç«¿" }, "æˆŸ": { en: "Trident", jp: "ãƒˆãƒ©ã‚¤ãƒ‡ãƒ³ãƒˆ" },
    "å‰ªåˆ€": { en: "Shears", jp: "ãƒã‚µãƒŸ" }, "ç›¾": { en: "Shield", jp: "ç›¾" },
    "é˜ç¿…": { en: "Elytra", jp: "ã‚¨ãƒªãƒˆãƒ©" }, "åˆ·å­": { en: "Brush", jp: "ãƒ–ãƒ©ã‚·" },
    "æ— ç­‰çº§": { en: "No Lvl", jp: "Lvãªã—" }, "äºŒçº§": { en: "Lvl 2", jp: "Lv 2" },
    "ä¸‰çº§": { en: "Lvl 3", jp: "Lv 3" }, "å››çº§": { en: "Lvl 4", jp: "Lv 4" },
    "äº”çº§": { en: "Lvl 5", jp: "Lv 5" }, "ä¸ƒçº§": { en: "Lvl 7", jp: "Lv 7" },
    "å…«çº§": { en: "Lvl 8", jp: "Lv 8" }
};

// ç•Œé¢è¯­è¨€åŒ…
const translations = {
    zh: {
        nav_title: "é—²äº‘é™„é­”ä¹¦æŸ¥è¯¢", hero_title: "é—²äº‘é™„é­”ä¹¦æŸ¥è¯¢", hero_subtitle: "æŸ¥è¯¢ä»·æ ¼ï¼Œæ·»åŠ è‡³æ¸…å•è‡ªåŠ¨è®¡ç®—æ€»é¢„ç®—",
        filter_all: "å…¨éƒ¨", filter_white: "ç™½ (æ™®é€š)", filter_green: "ç»¿ (ä¼˜ç§€)", filter_blue: "è“ (ç¨€æœ‰)",
        filter_purple: "ç´« (å²è¯—)", filter_gold: "é‡‘ (ä¼ è¯´)", filter_red: "çº¢ (ç¥è¯)",
        cart_title: "ä»·æ ¼è®¡ç®—å™¨", cart_empty: "æ¸…å•ç©ºç©ºå¦‚ä¹Ÿ", cart_total: "æ€»è®¡",
        btn_clear: "æ¸…ç©ºè®¡ç®—å™¨", confirm_title: "ç¡®è®¤æ¸…ç©º?", confirm_desc: "ä½ å°†ç§»é™¤æ‰€æœ‰å·²æ·»åŠ çš„é™„é­”ä¹¦ï¼Œæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚",
        btn_cancel: "å–æ¶ˆ", btn_confirm: "ç¡®è®¤æ¸…ç©º",
        label_price: "ä»·æ ¼", label_quality: "å“è´¨", label_target: "é€‚ç”¨ç‰©å“", label_conflicts: "å†²çªé™„é­”", btn_add: "è®¡ç®—ä»·æ ¼",
        lang_name: "ä¸­", view_list: "åˆ—è¡¨è§†å›¾", view_galaxy: "æ˜Ÿå›¾è§†å›¾",
        search_placeholder: "æœç´¢åç§°ã€ç”¨é€”ã€è£…å¤‡éƒ¨ä½..."
    },
    en: {
        nav_title: "Xianyun Enchant Search", hero_title: "Xianyun Enchant Search", hero_subtitle: "Calculate budget for your build",
        filter_all: "All", filter_white: "Common", filter_green: "Uncommon", filter_blue: "Rare",
        filter_purple: "Epic", filter_gold: "Legend", filter_red: "Mythic",
        cart_title: "Calculator", cart_empty: "List is empty", cart_total: "Total",
        btn_clear: "Clear All", confirm_title: "Clear list?", confirm_desc: "This will remove all items. Cannot be undone.",
        btn_cancel: "Cancel", btn_confirm: "Yes, Clear",
        label_price: "Price", label_quality: "Quality", label_target: "Target", label_conflicts: "Conflicts", btn_add: "Add to Calc",
        lang_name: "EN", view_list: "List View", view_galaxy: "Galaxy View",
        search_placeholder: "Search Name, Usage, Gear Slot..."
    },
    jp: {
        nav_title: "é–‘é›²ã‚¨ãƒ³ãƒãƒ£ãƒ³ãƒˆæ¤œç´¢", hero_title: "é–‘é›²ã‚¨ãƒ³ãƒãƒ£ãƒ³ãƒˆæ¤œç´¢", hero_subtitle: "ã‚¨ãƒ³ãƒãƒ£ãƒ³ãƒˆã®äºˆç®—ã‚’è¨ˆç®—ã—ã¾ã™",
        filter_all: "å…¨éƒ¨", filter_white: "ã‚³ãƒ¢ãƒ³", filter_green: "ã‚¢ãƒ³ã‚³ãƒ¢ãƒ³", filter_blue: "ãƒ¬ã‚¢",
        filter_purple: "ã‚¨ãƒ”ãƒƒã‚¯", filter_gold: "ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰", filter_red: "ãƒŸã‚·ãƒƒã‚¯",
        cart_title: "ä¾¡æ ¼è¨ˆç®—", cart_empty: "ãƒªã‚¹ãƒˆã¯ç©ºã§ã™", cart_total: "åˆè¨ˆ",
        btn_clear: "ã‚¯ãƒªã‚¢", confirm_title: "å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ", confirm_desc: "ãƒªã‚¹ãƒˆã®å†…å®¹ã¯ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚",
        btn_cancel: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«", btn_confirm: "ã¯ã„ã€å‰Šé™¤",
        label_price: "ä¾¡æ ¼", label_quality: "å“è³ª", label_target: "å¯¾è±¡", label_conflicts: "ç«¶åˆ", btn_add: "è¿½åŠ ",
        lang_name: "JP", view_list: "ãƒªã‚¹ãƒˆ", view_galaxy: "æ˜Ÿå›³",
        search_placeholder: "åå‰ã€ç”¨é€”ã€è£…å‚™éƒ¨ä½ã‚’æ¤œç´¢..."
    }
};

const colorHexMap = {
    'ç™½': 'var(--q-white)', 'ç»¿': 'var(--q-green)', 'è“': 'var(--q-blue)', 
    'ç´«': 'var(--q-purple)', 'é‡‘': 'var(--q-gold)', 'çº¢': 'var(--q-red)'
};
const hexValues = {
    'ç™½': '#909399', 'ç»¿': '#67c23a', 'è“': '#409eff', 
    'ç´«': '#a355d6', 'é‡‘': '#e6a23c', 'çº¢': '#f56c6c'
};

// å…¨å±€çŠ¶æ€
let db = [];
let qualityLookup = {}; // ç”¨äºå†²çªé¢œè‰²æŸ¥æ‰¾
let currentLang = 'zh';
let currentView = 'list';
let cart = [];
let currentFilter = 'all'; 
let currentSearch = '';

// --- åˆå§‹åŒ–åŠ è½½æ•°æ® ---
async function init() {
    try {
        // åŠ è½½æ•°æ®
        const response = await fetch('data.json?t=' + new Date().getTime());
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const rawData = await response.json();
        
        // å¤„ç†æ•°æ®
        db = rawData.map(item => {
            const transName = translationDB[item.name_zh] || {};
            const transLevel = translationDB[item.level_zh] || {};
            
            // æ„å»ºé¢œè‰²æŸ¥æ‰¾è¡¨
            qualityLookup[item.name_zh] = item.color;

            return {
                ...item,
                id: item.name_zh,
                name_en: transName.en || item.name_zh,
                name_jp: transName.jp || item.name_zh,
                desc_en: transName.desc_en || item.desc_zh,
                desc_jp: transName.desc_jp || item.desc_zh,
                target_en: translateList(item.target_zh, 'en'),
                target_jp: translateList(item.target_zh, 'jp'),
                conflicts_en: translateList(item.conflicts_zh, 'en'),
                conflicts_jp: translateList(item.conflicts_zh, 'jp'),
                level_en: transLevel.en || item.level_zh,
                level_jp: transLevel.jp || item.level_zh,
                priceValue: parseFloat(item.price) || 0
            };
        });

        // åˆå§‹åŒ– UI
        render();
        checkTimeTheme();
        setupEventListeners();

    } catch (error) {
        console.error("æ— æ³•åŠ è½½æ•°æ®:", error);
        document.getElementById('gridContainer').innerHTML = 
            `<div style="text-align:center;padding:50px;color:var(--c-text-secondary)">
                <i class="fa-solid fa-circle-exclamation" style="font-size:3rem;margin-bottom:20px"></i><br>
                æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ data.json æ–‡ä»¶<br>
                <small>${error.message}</small>
            </div>`;
    }
}

// è¾…åŠ©ç¿»è¯‘å‡½æ•°
function getTrans(raw, lang) {
    if(!raw) return "";
    if(translationDB[raw] && translationDB[raw][lang]) return translationDB[raw][lang];
    return raw;
}

function translateList(str, lang) {
    if(!str || str === 'æ— å†²çª') return translationDB['æ— å†²çª'][lang];
    return str.split(/,|ï¼Œ/).map(s => getTrans(s.trim(), lang)).join(', ');
}

// --- è§†å›¾åˆ‡æ¢åŠ¨ç”»é€»è¾‘ ---
function switchView(viewName) {
    if (currentView === viewName) return;
    
    const t = translations[currentLang];
    const oldKey = `view_${currentView}`;
    const newKey = `view_${viewName}`;
    
    let arrowDir = "â†’";
    let leftText = "", rightText = "";

    if (currentView === 'list' && viewName === 'galaxy') {
        arrowDir = "â†’";
        leftText = t.view_list;
        rightText = t.view_galaxy;
    } else if (currentView === 'galaxy' && viewName === 'list') {
        arrowDir = "â†";
        leftText = t.view_list;
        rightText = t.view_galaxy;
    } else {
        leftText = t[oldKey];
        rightText = t[newKey];
    }

    triggerGate(
        () => {
            currentView = viewName;
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.view-icon-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`btn-${viewName}`).classList.add('active');
            document.getElementById(`view-${viewName}`).classList.add('active');

            if (viewName === 'galaxy') renderGalaxy();
        },
        'horizontal',
        leftText, rightText, arrowDir
    );
}

function triggerGate(onMidPoint, type, leftText, rightText, arrowText) {
    const overlay = document.getElementById('gate-overlay');
    const arrow = document.getElementById('gate-arrow');
    overlay.className = '';
    overlay.classList.add(type === 'vertical' ? 'type-v' : 'type-h');
    if (type === 'horizontal') {
        document.getElementById('gate-text-left').innerText = leftText;
        document.getElementById('gate-text-right').innerText = rightText;
    }
    arrow.innerText = arrowText;
    overlay.classList.add('active');
    setTimeout(() => onMidPoint(), 600);
    setTimeout(() => overlay.classList.remove('active'), 1300);
}

// --- æ˜Ÿå›¾é€»è¾‘ (è¿çº¿ + é—ªçƒèŠ‚ç‚¹ + ç§»åŠ¨ç«¯æ”¯æŒ) ---
const galaxyContainer = document.getElementById('galaxy-container');
const galaxyNodes = document.getElementById('galaxy-nodes');
const galaxyCanvas = document.getElementById('galaxy-lines');
const ctx = galaxyCanvas.getContext('2d');
let galaxyScale = 1;
let galaxyPan = { x: 0, y: 0 };
let galaxyDragging = false;
let galaxyLastPos = { x: 0, y: 0 };
const miniTooltip = document.getElementById('mini-tooltip');

function renderGalaxy() {
    galaxyNodes.innerHTML = '';
    galaxyNodes.appendChild(galaxyCanvas); 
    
    galaxyScale = 1; galaxyPan = { x: galaxyContainer.offsetWidth/2, y: galaxyContainer.offsetHeight/2 };
    updateGalaxyTransform();

    const nodes = [];
    const arms = 3; 
    const maxDist = 1500;

    const items = [...db].sort(() => Math.random() - 0.5);

    items.forEach((item, i) => {
        const progress = i / items.length;
        const angle = progress * Math.PI * 12 + (i % arms) * (Math.PI * 2 / arms);
        const r = Math.sqrt(progress) * maxDist * (0.8 + Math.random() * 0.4);
        
        const x = Math.cos(angle) * r + (Math.random() - 0.5) * 150;
        const y = Math.sin(angle) * r + (Math.random() - 0.5) * 150;

        nodes.push({ x, y, item });

        const node = document.createElement('div');
        node.className = 'galaxy-node';
        const color = hexValues[item.color] || '#fff';
        node.style.setProperty('--node-color', color);
        node.style.left = x + 'px';
        node.style.top = y + 'px';
        
        node.style.animationDelay = `${Math.random() * 2}s`;
        
        node.innerHTML = `<div class="galaxy-label">${item[`name_${currentLang}`]}</div>`;
        
        node.onclick = (e) => { e.stopPropagation(); openModal(item); };
        node.onmouseenter = (e) => showMiniTooltip(e, item);
        node.onmouseleave = hideMiniTooltip;
        
        galaxyNodes.appendChild(node);
    });

    galaxyCanvas.width = 4000; galaxyCanvas.height = 4000;
    galaxyCanvas.style.left = '-2000px'; galaxyCanvas.style.top = '-2000px';
    
    const cx = 2000; const cy = 2000;
    ctx.clearRect(0,0,4000,4000);
    ctx.strokeStyle = 'rgba(255, 255, 255, 0.15)';
    ctx.lineWidth = 1;

    nodes.forEach((n1, idx) => {
        let connections = 0;
        for(let j = idx + 1; j < nodes.length; j++) {
            const n2 = nodes[j];
            const dx = n1.x - n2.x; const dy = n1.y - n2.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if (dist < 180 && connections < 3) { 
                ctx.beginPath();
                ctx.moveTo(cx + n1.x, cy + n1.y);
                ctx.lineTo(cx + n2.x, cy + n2.y);
                ctx.stroke();
                connections++;
            }
        }
    });
}

// æ˜Ÿå›¾äº¤äº’ (Mouse)
galaxyContainer.addEventListener('mousedown', e => { galaxyDragging = true; galaxyLastPos = { x: e.clientX, y: e.clientY }; });
window.addEventListener('mouseup', () => galaxyDragging = false);
window.addEventListener('mousemove', e => {
    if(galaxyDragging) {
        const dx = e.clientX - galaxyLastPos.x;
        const dy = e.clientY - galaxyLastPos.y;
        galaxyPan.x += dx; galaxyPan.y += dy;
        updateGalaxyTransform();
        galaxyLastPos = { x: e.clientX, y: e.clientY };
    }
    moveMiniTooltip(e);
});

// æ˜Ÿå›¾äº¤äº’ (Touch)
galaxyContainer.addEventListener('touchstart', e => {
    if(e.touches.length === 1) {
        galaxyDragging = true;
        galaxyLastPos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
    }
}, {passive: false});
window.addEventListener('touchend', () => galaxyDragging = false);
window.addEventListener('touchmove', e => {
    if(galaxyDragging && e.touches.length === 1) {
        e.preventDefault(); // é˜²æ­¢é¡µé¢æ»šåŠ¨
        const dx = e.touches[0].clientX - galaxyLastPos.x;
        const dy = e.touches[0].clientY - galaxyLastPos.y;
        galaxyPan.x += dx; galaxyPan.y += dy;
        updateGalaxyTransform();
        galaxyLastPos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
    }
}, {passive: false});


galaxyContainer.addEventListener('wheel', e => {
    e.preventDefault();
    const delta = e.deltaY > 0 ? 0.9 : 1.1;
    galaxyScale *= delta;
    galaxyScale = Math.min(Math.max(0.1, galaxyScale), 5);
    updateGalaxyTransform();
});

function updateGalaxyTransform() {
    galaxyNodes.style.transform = `translate(${galaxyPan.x}px, ${galaxyPan.y}px) scale(${galaxyScale})`;
}

// --- é€šç”¨åŠŸèƒ½ ---
function setLanguageWithGate(lang, fromIdx, toIdx) {
    const arrowDir = (toIdx > fromIdx) ? "â†’" : "â†";
    const minIdx = Math.min(fromIdx, toIdx); const maxIdx = Math.max(fromIdx, toIdx);
    const langOrder = ['zh', 'en', 'jp'];
    triggerGate(() => {
        currentLang = lang;
        updateAllText();
        render(); 
        updateCartUI();
        if(currentView === 'galaxy') renderGalaxy();
    }, 'horizontal', translations[langOrder[minIdx]].lang_name, translations[langOrder[maxIdx]].lang_name, arrowDir);
}
function updateAllText() {
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if(translations[currentLang][key]) el.innerText = translations[currentLang][key];
    });
    document.getElementById('searchInput').placeholder = translations[currentLang].search_placeholder;
}

function checkTimeTheme() {
    const hour = new Date().getHours();
    if (!(hour >= 6 && hour < 18)) { 
        document.body.setAttribute('data-theme', 'black');
        document.querySelector('#themeSwitch .toggle-option[data-theme="black"]').classList.add('active');
        document.querySelector('#themeSwitch .toggle-option[data-theme="white"]').classList.remove('active');
        document.querySelector('#themeSwitch .toggle-pill').style.transform = `translateX(100%)`;
    }
}

// --- æ–°å¢ï¼šé‡ç½®æœç´¢çŠ¶æ€å‡½æ•° ---
function resetToHome() {
    currentSearch = '';
    currentFilter = 'all';
    
    // æ¸…ç©ºè¾“å…¥æ¡†
    const input = document.getElementById('searchInput');
    if(input) input.value = '';
    
    // é‡ç½®ç­›é€‰æŒ‰é’®
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    const allBtn = document.querySelector('.filter-btn[data-color="all"]');
    if(allBtn) allBtn.classList.add('active');
    
    render();
}

// --- è¾…åŠ©ï¼šæ¨å…¥å†å²çŠ¶æ€ ---
function pushSearchState() {
    // åªæœ‰å½“å½“å‰ä¸åœ¨æœç´¢çŠ¶æ€ï¼ˆhistory.stateä¸ºç©ºæˆ–ä¸å«searchingæ ‡å¿—ï¼‰æ—¶æ‰æ¨å…¥
    if (!history.state || !history.state.searching) {
        history.pushState({ searching: true }, '');
    }
}

// äº‹ä»¶ç»‘å®š
function setupEventListeners() {
    // --- æ–°å¢ï¼šç›‘å¬æµè§ˆå™¨è¿”å›äº‹ä»¶ (Popstate) ---
    window.addEventListener('popstate', (event) => {
        // å¦‚æœå›åˆ°äº†ç©ºçŠ¶æ€ï¼ˆå³æ²¡æœ‰searchingæ ‡å¿—ï¼‰ï¼Œåˆ™é‡ç½®é¡µé¢
        if (!event.state || !event.state.searching) {
            resetToHome();
        }
    });

    // Lang Switch
    document.querySelectorAll('#langSwitch .toggle-option').forEach((opt, idx) => {
        opt.addEventListener('click', () => {
            const currentIdx = parseInt(document.querySelector('#langSwitch .toggle-option.active').dataset.idx);
            if(currentIdx === parseInt(opt.dataset.idx)) return;
            document.querySelector('#langSwitch .toggle-pill').style.transform = `translateX(${idx * 100}%)`;
            document.querySelectorAll('#langSwitch .toggle-option').forEach(o => o.classList.remove('active'));
            opt.classList.add('active');
            setLanguageWithGate(opt.dataset.lang, currentIdx, parseInt(opt.dataset.idx));
        });
    });

    // Theme Switch
    document.querySelectorAll('#themeSwitch .toggle-option').forEach((opt, idx) => {
        opt.addEventListener('click', () => {
            if(opt.classList.contains('active')) return;
            document.querySelector('#themeSwitch .toggle-pill').style.transform = `translateX(${idx * 100}%)`;
            document.querySelectorAll('#themeSwitch .toggle-option').forEach(o => o.classList.remove('active'));
            opt.classList.add('active');
            const theme = opt.dataset.theme;
            triggerGate(() => document.body.setAttribute('data-theme', theme), 'vertical', '', '', theme === 'black' ? 'â†“' : 'â†‘');
        });
    });

    // Filters
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentFilter = btn.dataset.color;
            
            // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯"å…¨éƒ¨"ï¼Œåˆ™æ¨å…¥å†å²çŠ¶æ€
            if (currentFilter !== 'all') {
                pushSearchState();
            } else if (currentSearch === '') {
                 // å¦‚æœåˆ‡å›"å…¨éƒ¨"ä¸”æ²¡æœ‰æœç´¢è¯ï¼Œä¸”å½“å‰åœ¨æœç´¢çŠ¶æ€ï¼Œå¯ä»¥è€ƒè™‘æ˜¯å¦å›é€€(å¯é€‰ï¼Œè¿™é‡Œä¸ºäº†ç®€å•ä¸åšå›é€€)
            }
            
            render();
        });
    });

    // Search
    document.getElementById('searchInput').addEventListener('input', e => { 
        currentSearch = e.target.value.toLowerCase();
        // åªè¦æœ‰è¾“å…¥å†…å®¹ï¼Œæ¨å…¥å†å²çŠ¶æ€
        if (currentSearch.trim() !== '') {
            pushSearchState();
        }
        render(); 
    });

    // Confirm Modal
    const confirmModal = document.getElementById('confirmModal');
    document.getElementById('openClearConfirm').addEventListener('click', () => { if(cart.length > 0) confirmModal.classList.add('active'); });
    
    // Cart & Modal Keys
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            if (confirmModal.classList.contains('active')) return closeConfirm();
            if (modalOverlay.classList.contains('active')) return closeModal();
            if (cartSidebar.classList.contains('open')) return closeSidebar();
            if (document.getElementById('searchInput').value !== '') { 
                // PCç«¯ ESC é”®é€»è¾‘ä¹Ÿå¤ç”¨é‡ç½®
                resetToHome();
                // å¦‚æœæœ‰å†å²è®°å½•ï¼Œä¹Ÿå¯ä»¥å›é€€
                if (history.state && history.state.searching) history.back();
            }
        }
    });
}

// åˆ—è¡¨æ¸²æŸ“
const grid = document.getElementById('gridContainer');
function render() {
    grid.innerHTML = '';
    const filtered = db.filter(item => {
        const matchColor = currentFilter === 'all' || item.color === currentFilter;
        const text = (item[`name_${currentLang}`] + item[`desc_${currentLang}`] + item[`target_${currentLang}`]).toLowerCase();
        return matchColor && text.includes(currentSearch);
    });
    filtered.forEach((item, idx) => {
        const card = document.createElement('div');
        card.className = `card`;
        card.style.setProperty('--card-color', colorHexMap[item.color]);
        card.style.animation = `slideLeft 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards`;
        card.style.animationDelay = `${idx * 0.03}s`;
        card.innerHTML = `
            <div class="card-header"><div class="card-title">${item[`name_${currentLang}`]}</div><div class="card-price">ğŸª™ ${item.price}</div></div>
            <div class="card-body">${item[`desc_${currentLang}`]}</div>
            <div class="card-footer"><span>${item[`level_${currentLang}`]}</span><span>${item[`target_${currentLang}`].split(',')[0]}...</span></div>
            <button class="card-action-btn" onclick="event.stopPropagation(); addToCart('${item.id}')"><i class="fa-solid fa-plus"></i></button>
        `;
        card.addEventListener('click', () => openModal(item));
        grid.appendChild(card);
    });
}

// æ¨¡æ€æ¡†
const modalOverlay = document.getElementById('modalOverlay');
const modalContent = document.getElementById('modalContent');
function openModal(item) {
    const t = translations[currentLang];
    const rawConflicts = item.conflicts_zh.split(/,|ï¼Œ/).map(c => c.trim());
    const displayConflicts = item[`conflicts_${currentLang}`].split(',').map(c => c.trim());
    let conflictHtml = '';
    if (item.conflicts_zh === 'æ— å†²çª' || !item.conflicts_zh) conflictHtml = `<span style="color:var(--c-text-light)">-</span>`;
    else {
        conflictHtml = rawConflicts.map((rawName, index) => {
            const colorKey = qualityLookup[rawName] || 'ç™½';
            const colorVar = colorHexMap[colorKey] || 'var(--c-border)';
            return `<span class="conflict-tag" style="background-color:${colorVar}">${displayConflicts[index] || rawName}</span>`;
        }).join('');
    }
    modalContent.innerHTML = `
        <button class="modal-close-btn" onclick="closeModal()"><i class="fa-solid fa-xmark"></i></button>
        <div class="modal-header"><div class="modal-title" style="color:var(--c-text)">${item[`name_${currentLang}`]}</div></div>
        <div style="background:var(--c-bg);padding:15px;border-radius:8px;color:var(--c-text-secondary);line-height:1.6">${item[`desc_${currentLang}`]}</div>
        <div class="detail-grid">
            <div class="detail-label">${t.label_price}</div><div class="detail-value" style="color:#d35400;font-weight:bold">ğŸª™ ${item.price}</div>
            <div class="detail-label">${t.label_quality}</div><div class="detail-value" style="color:${colorHexMap[item.color]};font-weight:bold">${item.color}</div>
            <div class="detail-label">${t.label_target}</div><div class="detail-value">${item[`target_${currentLang}`]}</div>
            <div class="detail-label">${t.label_conflicts}</div><div class="detail-value" style="line-height:1.8">${conflictHtml}</div>
        </div>
        <button class="btn-block" style="background:var(--c-text);color:var(--c-bg);margin-top:20px" onclick="addToCart('${item.id}');closeModal()">${t.btn_add}</button>
    `;
    modalOverlay.classList.add('active');
}
function closeModal() { modalOverlay.classList.remove('active'); }
modalOverlay.addEventListener('click', e => { if(e.target === modalOverlay) closeModal(); });

// è´­ç‰©è½¦é€»è¾‘ (æ›´æ–°ç‰ˆï¼šæ”¯æŒæ•°é‡)
const cartSidebar = document.getElementById('cartSidebar');

// æ·»åŠ å•†å“
function addToCart(id) {
    const dbItem = db.find(i => i.id === id);
    if (!dbItem) return;

    const existingItem = cart.find(i => i.id === id);
    if (existingItem) {
        existingItem.quantity += 1;
    } else {
        cart.push({ ...dbItem, quantity: 1 });
    }

    updateCartUI();
    if(navigator.vibrate) navigator.vibrate(10);
}

// ç§»é™¤å•†å“
function removeFromCart(index) {
    cart.splice(index, 1);
    updateCartUI();
}

// æ›´æ”¹æ•°é‡
function changeQty(index, delta) {
    const item = cart[index];
    const newQty = item.quantity + delta;
    if (newQty <= 0) {
        removeFromCart(index);
    } else {
        item.quantity = newQty;
        updateCartUI();
    }
}

// æ‰‹åŠ¨è¾“å…¥æ•°é‡
function inputQty(index, value) {
    let qty = parseInt(value);
    if (isNaN(qty) || qty < 1) qty = 1;
    cart[index].quantity = qty;
    updateCartUI();
}

// æ›´æ–°UI
function updateCartUI() {
    const countEl = document.getElementById('cartCount');
    const listEl = document.getElementById('cartItems');
    const totalEl = document.getElementById('totalPrice');
    
    const totalQty = cart.reduce((sum, item) => sum + item.quantity, 0);
    countEl.innerText = totalQty;
    countEl.classList.toggle('visible', totalQty > 0);

    const t = translations[currentLang];
    if (cart.length === 0) {
        listEl.innerHTML = `<div style="text-align:center;color:var(--c-text-light);margin-top:4rem;">${t.cart_empty}</div>`;
        totalEl.innerText = `ğŸª™ 0`;
        return;
    }

    listEl.innerHTML = cart.map((item, i) => `
        <div class="cart-item">
            <div class="cart-item-info">
                <div style="font-weight:bold;color:var(--c-text)">${item[`name_${currentLang}`]}</div>
                <div style="font-size:0.85rem;color:#d35400;margin-top:2px">ğŸª™ ${item.price} Ã— ${item.quantity}</div>
            </div>
            <div class="cart-controls">
                <div class="qty-group">
                    <button class="qty-btn" onclick="changeQty(${i}, -1)"><i class="fa-solid fa-minus"></i></button>
                    <input type="number" class="qty-input" value="${item.quantity}" onchange="inputQty(${i}, this.value)" onfocus="this.select()">
                    <button class="qty-btn" onclick="changeQty(${i}, 1)"><i class="fa-solid fa-plus"></i></button>
                </div>
                <div class="cart-del-btn" onclick="removeFromCart(${i})">
                    <i class="fa-solid fa-trash"></i>
                </div>
            </div>
        </div>
    `).join('');

    const totalPrice = cart.reduce((acc, item) => acc + (item.priceValue * item.quantity), 0);
    totalEl.innerText = `ğŸª™ ${totalPrice.toLocaleString()}`;
}

document.getElementById('cartFab').addEventListener('click', () => cartSidebar.classList.add('open'));
function closeSidebar() { cartSidebar.classList.remove('open'); }
function closeConfirm() { document.getElementById('confirmModal').classList.remove('active'); }
function performClear() { cart = []; updateCartUI(); closeConfirm(); closeSidebar(); }

// æ‚¬æµ®çª—å†…å®¹æ›´æ–°
function showMiniTooltip(e, item) {
    if(window.innerWidth < 768) return;
    miniTooltip.querySelector('.tooltip-name').innerText = item[`name_${currentLang}`];
    miniTooltip.querySelector('.tooltip-name').style.color = colorHexMap[item.color];
    miniTooltip.querySelector('.tooltip-price').innerText = `ğŸª™ ${item.price}`;
    miniTooltip.querySelector('.tooltip-desc').innerText = item[`desc_${currentLang}`];
    miniTooltip.classList.add('visible'); moveMiniTooltip(e);
}
function hideMiniTooltip() { miniTooltip.classList.remove('visible'); }
function moveMiniTooltip(e) {
    if(!miniTooltip.classList.contains('visible')) return;
    miniTooltip.style.top = (e.clientY + 15) + 'px'; miniTooltip.style.left = (e.clientX + 15) + 'px';
}

// å¯åŠ¨åº”ç”¨
init();

</script>
</body>
</html>
